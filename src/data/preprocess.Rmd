---
title: "analysis_preprocess"
author: "Álvaro Domingo"
date: "2023-08-19"
output: html_document
---

```{r}
library(VGAM)
library(ggplot2)
library(dplyr)
library(tidyr)
library(lmtest)
library(stringr)
library(emmeans)
library(aod)
library(plm)
library(reshape2)
library(corrplot)
```

## Read data

```{r}
# Define global variables
N = 50
s = 10

# Read data
history = subset(read.csv("../../data/raw/history.csv"), select=-X)
codecarbon = subset(read.csv("../../data/raw/emissions.csv"), select=-X)
nvidia = subset(read.csv("../../data/raw/monitor.csv"), select=-X)
datasets = read.csv("../../data/raw/datasets.csv")
```

## Process attributes and merge

```{r}
# Parse attributes
colnames(codecarbon)[colnames(codecarbon) == "timestamp"] = "end"
codecarbon$start = as.POSIXct(codecarbon$start, format = "%Y-%m-%d %H:%M:%OS")
codecarbon$end = as.POSIXct(codecarbon$end, format = "%Y-%m-%d %H:%M:%OS")

colnames(nvidia) = c("timestamp", "utilization_gpu", "utilization_memory", "memory_total", "memory_used", "power_draw", "temperature_gpu")
nvidia$timestamp = as.POSIXct(nvidia$timestamp, format = "%Y-%m-%d %H:%M:%OS")
cols = c("utilization_gpu", "utilization_memory", "memory_total", "memory_used", "power_draw")
nvidia[cols] <- lapply(nvidia[cols], function(x) as.numeric(sapply(x, function(val) unlist(strsplit(as.character(val), " "))[2]))) # Value is after a blank space

# Process accuracies
history$accuracy = ifelse(history$accuracy == 0, 1 / datasets$num_classes[match(history$dataset, datasets$dataset)], history$accuracy)
history$val_accuracy = ifelse(history$val_accuracy == 0, 1 / datasets$num_classes[match(history$dataset, datasets$dataset)], history$val_accuracy)
history["logodds"] = logitlink(history$accuracy)
history["val_logodds"] = logitlink(history$val_accuracy)

hist.carbon = left_join(history, codecarbon, by=c("dataset", "mode", "intervention", "epoch"))
hist.carbon = hist.carbon %>% mutate(dataset = recode(dataset, "visual_domain_decathlon/aircraft" = "aircraft"))
datasets = datasets %>% mutate(dataset = recode(dataset, "visual_domain_decathlon/aircraft" = "aircraft"))
datasets = bind_rows(datasets[11, ], datasets[-11, ])

# Final merge
all_data = hist.carbon %>%
  rowwise() %>%
  mutate(subset_nvidia = nvidia %>%
           filter(timestamp >= start, timestamp <= end) %>%
           subset(select=-timestamp) %>%
           do(data.frame(t(colMeans(.))))) %>%
  unnest(subset_nvidia) %>%
  as.data.frame()

all_data$energy_nvidia = all_data$power_draw * all_data$duration / 3600000

remove(nvidia, history, codecarbon, hist.carbon)
```

## Add cumulative variables

```{r}
center = function(df, attribute) {
  return (ave(as.vector(df[,attribute]), df$dataset, FUN = function(x) x - mean(x)) + mean(df[,attribute]))
}

get_cumulative <- function(df, row, attribute) {
  dataset <- row["dataset"]
  mode <- row["mode"]
  intervention <- as.numeric(row["intervention"])
  epoch <- as.numeric(row["epoch"])
  if (mode == "base") {
    return(sum(df[df$dataset == dataset &
                          df$mode == "base" & 
                          df$epoch <= epoch, attribute]))
  }
  else {
    base_energy <- sum(df[df$dataset == dataset & 
                                   df$mode == "base" & 
                                   df$epoch <= intervention, attribute])
    intervention_energy <- sum(df[df$dataset == dataset & 
                                           df$mode == mode &
                                           df$intervention == intervention & 
                                           df$epoch <= epoch, attribute])
    return(base_energy + intervention_energy)
  }
}

all_data$val_logodds_centered = center(all_data, "val_logodds")
all_data$logodds_centered = center(all_data, "logodds")
all_data$energy_centered = center(all_data, "energy_consumed")
all_data$energy_nvidia_centered = center(all_data, "energy_nvidia")
all_data$duration_centered = center(all_data, "duration")

all_data$energy_centered_cumulative <- apply(all_data, 1, get_cumulative, df=all_data, attribute="energy_centered")
all_data$duration_centered_cumulative <- apply(all_data, 1, get_cumulative, df=all_data, attribute="duration_centered")
all_data$energy_nvidia_centered_cumulative <- apply(all_data, 1, get_cumulative, df=all_data, attribute="energy_nvidia_centered")

all_data$energy_nvidia_cumulative <- apply(all_data, 1, get_cumulative, df=all_data, attribute="energy_nvidia")
all_data$energy_cumulative <- apply(all_data, 1, get_cumulative, df=all_data, attribute="energy_consumed")
all_data$duration_cumulative <- apply(all_data, 1, get_cumulative, df=all_data, attribute="duration")
all_data$score = all_data$val_accuracy / all_data$energy_nvidia_cumulative
```

## Add scaled variables

```{r}
scale_df = function(df, attribute) {
  return (ave(as.vector(df[,attribute]), df$dataset, FUN = function(x) (x - mean(x)) / sd(x)) + mean(df[,attribute]))
}
scale_df2 = function(df, attribute) {
  return (ave(as.vector(df[,attribute]), df$dataset, df$mode, FUN = function(x) (x - mean(x)) / sd(x)))
}


all_data$temperature_gpu_centered = center(all_data, "temperature_gpu")

all_data$val_logodds_scaled = scale_df(all_data, "val_logodds")
all_data$logodds_scaled = scale_df(all_data, "logodds")
all_data$energy_scaled = scale_df(all_data, "energy_consumed")
all_data$energy_nvidia_scaled = scale_df(all_data, "energy_nvidia")
all_data$duration_scaled = scale_df(all_data, "duration")
all_data$temperature_gpu_scaled = scale_df(all_data, "temperature_gpu")
all_data$utilization_gpu_scaled = scale_df(all_data, "utilization_gpu")

all_data$val_logodds_scaled2 = scale_df2(all_data, "val_logodds")
all_data$logodds_scaled2 = scale_df2(all_data, "logodds")
all_data$energy_scaled2 = scale_df2(all_data, "energy_consumed")
all_data$energy_nvidia_scaled2 = scale_df2(all_data, "energy_nvidia")
all_data$duration_scaled2 = scale_df2(all_data, "duration")
all_data$temperature_gpu_scaled2 = scale_df2(all_data, "temperature_gpu")
all_data$utilization_gpu_scaled2 = scale_df2(all_data, "utilization_gpu")
```

## Write processed data

```{r}
write.csv(all_data, "../../data/processed/all_data.csv")
```

### Visualize

```{r}
# Read to skip data prep
all_data = subset(read.csv("../../data/raw/all_data.csv"), select=-X)
datasets = read.csv("../../data/raw/datasets.csv")
datasets$dataset[datasets$dataset=="visual_domain_decathlon/aircraft"] = "aircraft"
all_data = left_join(all_data, datasets, by="dataset")
high_energy = c("birdsnap", "cifar10", "cifar100", "food101", "sun397")
N = 50
s = 10
```

```{r}
var.plot = "temperature_gpu"
par(mfrow=c(3,4), mar=c(1.3,1.7,1,0), oma=c(0,0,2,0), mgp=c(1.3,0.5,0), cex.main=1.4, cex.axis=1.1)

# Loop over datasets
for (d in datasets$dataset) {
  history_part <- all_data[all_data$dataset == d, ]
  
  # Plot each subplot
  plot(NULL, xlim=c(0,N), ylim=range(history_part[,var.plot]), xlab="", ylab="", main=d)
  for (i in seq(0, N, by=s)) {
    branch <- history_part[history_part$intervention == i & history_part$mode == "freeze", ]
    lines(branch$epoch, branch[,var.plot], col="green", type='l')
    branch <- history_part[history_part$intervention == i & history_part$mode == "quant", ]
    lines(branch$epoch, branch[,var.plot], col="red", type='l')
  }
  branch <- history_part[history_part$mode == "base", ]
  lines(branch$epoch, branch[,var.plot], col="blue", type='l')
  
  #rational = function(x, c, b) {c / (x + b)}
  #y = history_part$score[1:50]
  #fit = nls(y ~ rational(seq(1,50), c, b), start = list(c = 100, b = 10))
  #lines(predict(fit, seq(1,50)), col="black")
  #abline(v = -coef(fit)[["b"]] + sqrt(coef(fit)[["c"]]))
  #print(d)
  #print(-coef(fit)[["b"]] + sqrt(coef(fit)[["c"]]))
}

mtext("GPU temperature (ºC)", outer=TRUE, line=0, cex=1.3)
```

## Analyze data

### Energy measurements comparison
```{r}
energy_diff = lm(all_data$energy_consumed~all_data$energy_nvidia)
print(summary(energy_diff))
part_data = all_data[all_data$dataset != "birdsnap",]
energy_diff2 = lm(part_data$energy_consumed~part_data$energy_nvidia)
print(summary(energy_diff2))
ggplot(all_data, aes(x = energy_nvidia, y = energy_consumed, color = factor(dataset))) +
  geom_point(alpha=0.5) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
  stat_smooth(geom="line", method = "lm", se = FALSE, color = "blue", alpha=0.5) +
  labs(x = "Energy measured by nvidia-smi (kW h)", y = "Energy measured by CodeCarbon (kW h)", color = "Dataset", shape="Dataset") +
  scale_x_log10() +
  scale_y_log10() +
  theme_minimal()
```

### Dataset separation exploration

```{r}
model_simple = lm(energy_nvidia ~ train_size, all_data)
model_complex = lm(energy_nvidia ~ train_size + num_classes, all_data)

# Calculate AIC and BIC for each model
aic_simple <- AIC(model_simple)
bic_simple <- BIC(model_simple)

aic_complex <- AIC(model_complex)
bic_complex <- BIC(model_complex)

# Calculate the likelihood ratio (LR)
aic_lr <- aic_simple - aic_complex
bic_lr <- bic_simple - bic_complex

# Calculate the number of additional parameters in the complex model
num_additional_parameters <- length(coef(model_complex)) - length(coef(model_simple))

# Calculate the p-value using the chi-squared distribution
aic_p_value <- 1 - pchisq(aic_lr, df = num_additional_parameters)
bic_p_value <- 1 - pchisq(bic_lr, df = num_additional_parameters)

# Print the p-values
print(paste("AIC p-value:", aic_p_value))
print(paste("BIC p-value:", bic_p_value))
```

### General correlations

```{r}
corrplot(cor(all_data[c(35,49,50,48,29,19,20,34)]), method="color", outline="white")
```

### Energy against train size

```{r}
energy_dataset = lm(energy_nvidia ~ train_size, all_data)
energy_dataset2 = lm(energy_nvidia ~ test_size, all_data)
energy_dataset3 = lm(energy_nvidia ~ num_classes, all_data)
print(summary(energy_dataset))
print(summary(energy_dataset2))
print(summary(energy_dataset3))

ggplot(all_data, aes(x = train_size, y = energy_nvidia, color = factor(dataset))) +
  geom_point(alpha = 0.5) +
  stat_smooth(geom="line", method = "lm", se = FALSE, color = "blue", alpha=0.5) +
  labs(x = "Train instances", y = "Energy consumed (kW h)", color = "Dataset") +
  theme_minimal()

ggplot(all_data, aes(x = train_size, y = energy_nvidia, color = factor(dataset))) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(x = "Train instances", y = "Energy consumed (kW h)", color = "Dataset") +
  theme_minimal()
```

### Emissions against energy

```{r}
ggplot(all_data, aes(x = energy_consumed, y = emissions, color = factor(dataset))) +
  geom_point(alpha=0.5) +
  stat_smooth(geom="line", method = "lm", se = FALSE, color = "blue", alpha = 0.5) +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Energy measured by Nvidia-smi (kW h)", y = "Emissions (Kg CO2eq)") +
  theme_minimal()

ggplot(all_data, aes(x = energy_nvidia, y = emissions, color = factor(dataset))) +
  geom_point(alpha=0.5) +
  stat_smooth(geom="line", method = "lm", se = FALSE, color = "blue", alpha = 0.5) +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Energy measured by CodeCarbon (kW h)", y = "Emissions (Kg CO2eq)") +
  theme_minimal()

emissions_nvidia = lm(emissions ~ energy_nvidia, data=all_data)
emissions_codecarbon = lm(emissions ~ energy_consumed, data=all_data)
energy_diff = lm(all_data$energy_consumed~all_data$energy_nvidia)
print(summary(energy_diff))
print(summary(emissions_nvidia))
print(summary(emissions_codecarbon))
```

### Energy against Duration and GPU usage

```{r}
duration_gpu = lm(duration ~ utilization_gpu, all_data)
energy_duration = lm(energy_nvidia ~ duration, all_data)
energy_duration_log = lm(log10(energy_nvidia) ~ log10(duration), all_data)
energy_gpu = lm(energy_nvidia ~ utilization_gpu, all_data)
energy_gpu_dataset = lm(energy_nvidia ~ utilization_gpu * dataset, all_data)
energy_duration_gpu = lm(energy_nvidia ~ duration + utilization_gpu, all_data)
print(summary(duration_gpu))
print(summary(energy_duration))
print(summary(energy_gpu))
print(summary(energy_gpu_dataset))
print(summary(energy_duration_gpu))
print(anova(energy_duration, energy_duration_gpu))

ggplot(all_data, aes(x = duration, y = energy_nvidia, color = factor(dataset), shape = factor(mode))) +
  geom_point(alpha=0.5) +
  geom_abline(intercept=energy_duration_log$coefficients[1], slope=energy_duration_log$coefficients[2], color = "blue", alpha = 0.5) +
  scale_shape_manual(values = c(1, 2, 3), labels = c("Base mode", "Layer freezing", "Model quantization")) +
  labs(x = "Duration (s)", y = "Energy consumed (kW h)", color = "Dataset", shape = "Training mode") +
  scale_x_log10() +
  scale_y_log10() +
  theme_minimal() +
  theme(legend.key.size = unit(0.9, "lines"))

ggplot(all_data, aes(x = utilization_gpu, y = energy_nvidia, color = factor(dataset), shape = factor(mode))) +
  geom_point(alpha=0.5) +
  scale_shape_manual(values = c(1, 2, 3), labels = c("Base mode", "Layer freezing", "Model quantization")) +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "GPU utilization (%)", y = "Energy consumed (kW h)", color = "Dataset", shape = "Training mode") +
  theme_minimal() +
  theme(legend.key.size = unit(0.9, "lines"))

ggplot(all_data, aes(x = utilization_gpu, y = duration, color = factor(dataset), shape = factor(mode))) +
  geom_point(alpha=0.5) +
  scale_shape_manual(values = c(1, 2, 3), labels = c("Base mode", "Layer freezing", "Model quantization")) +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "GPU utilization (%)", y = "Duration (s)", color = "Dataset", shape = "Training mode") +
  theme_minimal() +
  theme(legend.key.size = unit(0.9, "lines"))
```


### Temperature against time

```{r}
ggplot(all_data, aes(x = epoch, y = temperature_gpu, color = factor(dataset), shape = factor(mode))) +
  geom_point(alpha=0.5) +
  #stat_smooth(geom="line", method="lm", se=FALSE, alpha=0.5, col="blue") +
  scale_shape_manual(values = c(1, 2, 3), labels = c("Base mode", "Layer freezing", "Model quantization")) +
  theme_minimal() +
  labs(x = "Epoch", y = "GPU temperature (ºC)", color = "Dataset", shape = "Training mode") +
  theme(legend.key.size = unit(0.9, "lines"))

ggplot(all_data, aes(x = duration_cumulative, y = temperature_gpu_centered, color = factor(dataset), shape = factor(mode))) +
  geom_point(alpha=0.5) +
  #stat_smooth(geom="line", method="lm", se=FALSE, alpha=0.5, col="blue") +
  scale_shape_manual(values = c(1, 2, 3), labels = c("Base mode", "Layer freezing", "Model quantization")) +
  theme_minimal() +
  labs(x = "Cumulative duration (s)", y = "Centered GPU temperature (ºC)", color = "Dataset", shape = "Training mode") +
  scale_x_log10() +
  scale_y_log10() +
  theme(legend.key.size = unit(0.9, "lines"))

part_data = subset(all_data, mode == "freeze" & intervention == 0, c("epoch", "dataset", "temperature_gpu"))
```


```{r}
part_data = subset(all_data, dataset == "cifar10" & mode == "freeze" & intervention == 0, c("epoch", "dataset", "temperature_gpu"))
plot(part_data$temperature_gpu)
acf(part_data$temperature_gpu[10:50])
```

### Temperature against duration and GPU usage

```{r}
temp_gpu = lm(temperature_gpu ~ utilization_gpu, all_data)
temp_gpu_scaled = lm(temperature_gpu_scaled2 ~ utilization_gpu_scaled2, all_data)
temp_duration_scaled = lm(temperature_gpu_scaled2 ~ duration_scaled2, all_data)
print(summary(temp_gpu))
print(summary(temp_gpu_scaled))
print(summary(temp_duration_scaled))

ggplot(all_data, aes(x = duration, y = temperature_gpu, color = factor(dataset), shape = factor(mode))) +
  geom_point(alpha=0.5) +
  #stat_smooth(geom="line", method="lm", se=FALSE, alpha=0.5, col="blue") +
  scale_shape_manual(values = c(1, 2, 3), labels = c("Base mode", "Layer freezing", "Model quantization")) +
  theme_minimal() +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Duration (s)", y = "GPU temperature (ºC)", color = "Dataset", shape = "Training mode") +
  theme(legend.key.size = unit(0.9, "lines"))


ggplot(all_data, aes(x = duration_scaled2, y = temperature_gpu_scaled2 , color = factor(dataset), shape = factor(mode))) +
  geom_point(alpha=0.5) +
  #stat_smooth(geom="line", method="lm", se=FALSE, alpha=0.5, col="blue") +
  geom_abline(slope=temp_duration_scaled$coefficients[2], intercept=temp_duration_scaled$coefficients[1], col="blue", alpha=0.5) +
  scale_shape_manual(values = c(1, 2, 3), labels = c("Base mode", "Layer freezing", "Model quantization")) +
  theme_minimal() +
  labs(x = "Scaled duration", y = "Scaled GPU temperature", color = "Dataset", shape = "Training mode") +
  theme(legend.key.size = unit(0.9, "lines"))

ggplot(all_data, aes(x = utilization_gpu, y = temperature_gpu, color = factor(dataset), shape = factor(mode))) +
  geom_point(alpha=0.5) +
  stat_smooth(geom="line", method="lm", se=FALSE, alpha=0.5, col="blue") +
  scale_shape_manual(values = c(1, 2, 3), labels = c("Base mode", "Layer freezing", "Model quantization")) +
  theme_minimal() +
  labs(x = "GPU utilization (%)", y = "GPU temperature (ºC)", color = "Dataset", shape = "Training mode") +
  theme(legend.key.size = unit(0.9, "lines"))

ggplot(all_data, aes(x = utilization_gpu_scaled2, y = temperature_gpu_scaled2, color = factor(dataset), shape = factor(mode))) +
  geom_point(alpha=0.5) +
  geom_abline(slope=temp_gpu_scaled$coefficients[2], intercept=temp_gpu_scaled$coefficients[1], col="blue", alpha=0.5) +
  #stat_smooth(geom="line", method="lm", se=FALSE, alpha=0.5, col="blue") +
  scale_shape_manual(values = c(1, 2, 3), labels = c("Base mode", "Layer freezing", "Model quantization")) +
  theme_minimal() +
  labs(x = "Scaled GPU utilization", y = "Scaled GPU temperature", color = "Dataset", shape = "Training mode") +
  theme(legend.key.size = unit(0.9, "lines"))
```



### Outlier exploration

```{r}
nvidia = subset(read.csv("../results/eatit_v1/monitor.csv"), select=-X)
colnames(nvidia) = c("timestamp", "utilization_gpu", "utilization_memory", "memory_total", "memory_used", "power_draw", "temperature_gpu")
nvidia$timestamp = as.POSIXct(nvidia$timestamp, format = "%Y-%m-%d %H:%M:%OS")
cols = c("utilization_gpu", "utilization_memory", "memory_total", "memory_used", "power_draw")
nvidia[cols] <- lapply(nvidia[cols], function(x) as.numeric(sapply(x, function(val) unlist(strsplit(as.character(val), " "))[2]))) # Value is after a blank space

all_data$start = as.POSIXct(all_data$start, format = "%Y-%m-%d %H:%M:%OS")
all_data$end = as.POSIXct(all_data$end, format = "%Y-%m-%d %H:%M:%OS")
nvidia$timestamp = as.POSIXct(nvidia$timestamp, format = "%Y-%m-%d %H:%M:%OS")
part_data = subset(all_data, subset = dataset == "food101" & mode == "freeze" & intervention == 0)
part_monitor = subset(nvidia, subset = timestamp > part_data$start[1] & timestamp < part_data$end[nrow(part_data)] )
```

```{r}
part_monitor$lapsed_time <- as.numeric(difftime(part_monitor$timestamp, min(part_monitor$timestamp), units = "secs"))

ggplot(part_monitor, aes(x = lapsed_time, y = utilization_gpu)) +
  geom_line() +
  geom_vline(data = part_data, aes(xintercept = as.numeric(difftime(start, min(part_monitor$timestamp), units = "secs"))), color = "blue") +
  geom_vline(data = part_data, aes(xintercept = as.numeric(difftime(end, min(part_monitor$timestamp), units = "secs"))), color = "red") +
  xlab("Lapsed time (s)") +
  ylab("GPU Utilization (%)") +
  xlim(1200, 1600) +
  theme_minimal()


```

